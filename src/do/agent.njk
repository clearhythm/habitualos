---
title: Agent - HabitualOS
layout: base.njk
permalink: /do/agent/
---

<div id="loading-agent" class="mb-xl">
  <p class="text-muted">Loading agent details...</p>
</div>

<div id="agent-error" class="mb-xl" style="display: none;">
  <div class="card">
    <h2 class="mb-md">Agent Not Found</h2>
    <p class="mb-md">The agent you're looking for doesn't exist or you don't have access to it.</p>
    <a href="/do/" class="btn btn-secondary">Back to Dashboard</a>
  </div>
</div>

<div id="agent-detail" style="display: none;">
  {# Breadcrumb Navigation #}
  <div class="mb-md">
    <a href="/do/" style="color: #6b7280; text-decoration: none; font-size: 0.95rem;">‚Üê Back to Dashboard</a>
  </div>

  {# Agent Header #}
  <div class="mb-md">
    <div class="flex flex-between mb-xs">
      <h1 id="agent-name">Agent Name</h1>
      <div>
        <span class="badge badge-open" id="agent-status-badge" style="margin-right: 0.5rem;">Active</span>
        <button class="btn btn-secondary btn-sm" id="toggle-agent-status-btn">Pause</button>
      </div>
    </div>

    {# Navigation Links #}
    <div style="display: flex; gap: 1.5rem; align-items: center; padding-top: 0.5rem;">
      <a href="#" class="agent-nav-link active" data-view="chat" style="font-size: 0.95rem; text-decoration: none; color: #2563eb; font-weight: 500;">
        Chat
      </a>
      <a href="#" class="agent-nav-link" data-view="actions" style="font-size: 0.95rem; text-decoration: none; color: #6b7280;">
        <span id="actions-count">0</span> actions
      </a>
      <a href="#" class="agent-nav-link" data-view="assets" style="font-size: 0.95rem; text-decoration: none; color: #6b7280;">
        <span id="assets-count">0</span> assets
      </a>
      <a href="#" class="agent-nav-link" data-view="settings" style="font-size: 0.95rem; text-decoration: none; color: #6b7280;">
        Settings
      </a>
    </div>
  </div>

  {# Chat Tab #}
  <div id="tab-chat" class="agent-tab-content" style="display: block;">
    <div id="agent-chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 280px);">
      <!-- Messages (scrollable area) -->
      <div id="agent-chat-messages" style="flex: 1; min-height: 0; overflow-y: auto; margin-bottom: 1rem;">
        <div id="agent-chat-messages-inner" style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 700px; margin: 0 auto; padding: 1rem;"></div>
      </div>

      <!-- Input area (fixed at bottom) -->
      <div style="flex-shrink: 0; padding: 0 1rem 1rem;">
        <div style="max-width: 700px; margin: 0 auto;">
          <form id="agent-chat-form">
            <div style="position: relative;">
              <textarea
                name="message"
                id="agent-message-input"
                placeholder="Ask about the goal, request actions, or provide context..."
                required
                rows="2"
                style="width: 100%; padding: 0.75rem 3rem 0.75rem 0.75rem; border: 1px solid #ddd; border-radius: 20px; font-size: 1rem; font-family: inherit; resize: none; max-height: 150px; overflow-y: auto; box-sizing: border-box;"
              ></textarea>
              <button
                type="submit"
                id="agent-send-button"
                disabled
                style="position: absolute; right: 0.5rem; bottom: 0.5rem; width: 32px; height: 32px; background: #ddd; color: white; border: none; border-radius: 50%; cursor: not-allowed; transition: all 0.2s; display: flex; align-items: center; justify-content: center; padding: 0;"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M208.49,120.49a12,12,0,0,1-17,0L140,69V216a12,12,0,0,1-24,0V69L64.49,120.49a12,12,0,0,1-17-17l72-72a12,12,0,0,1,17,0l72,72A12,12,0,0,1,208.49,120.49Z"></path>
                </svg>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# Actions Tab #}
  <div id="tab-actions" class="agent-tab-content" style="display: none;">
    <div class="mb-md">
      <div class="flex flex-between">
        <h2>Deliverables</h2>
        <select id="actions-filter" class="actions-filter-select">
          <option value="all">All</option>
          <option value="scheduled">Scheduled</option>
          <option value="active">Active</option>
          <option value="completed">Completed</option>
        </select>
      </div>
    </div>
    <div class="actions-grid" id="agent-actions-grid"></div>
  </div>

  {# Assets Tab #}
  <div id="tab-assets" class="agent-tab-content" style="display: none;">
    <h2 class="mb-md">Created Assets</h2>
    <p class="text-muted">Files and artifacts created by this agent will appear here.</p>
  </div>

  {# Settings Tab #}
  <div id="tab-settings" class="agent-tab-content" style="display: none;">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem;">

      {# Left Card: Agent Overview (1/3) #}
      <div class="card">
        <h3 class="mb-md">Overview</h3>

        {# Agent Metrics #}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <p class="text-muted text-sm mb-xs">Status</p>
            <p id="agent-status-text">Active</p>
          </div>
          <div>
            <p class="text-muted text-sm mb-xs">Model</p>
            <p id="agent-model">Sonnet 4.5</p>
          </div>
          <div>
            <p class="text-muted text-sm mb-xs">Runtime</p>
            <p id="agent-runtime">0 days</p>
          </div>
          <div>
            <p class="text-muted text-sm mb-xs">Total Cost</p>
            <p id="agent-cost">$0.00</p>
          </div>
          <div>
            <p class="text-muted text-sm mb-xs">Projected Cost</p>
            <p class="text-muted" id="agent-projected">~$0.00/mo</p>
          </div>
          <div>
            <p class="text-muted text-sm mb-xs">Total Actions</p>
            <p id="agent-total-actions">0</p>
          </div>
          <div>
            <p class="text-muted text-sm mb-xs">Completed</p>
            <p id="agent-completed-actions">0</p>
          </div>
        </div>
      </div>

      {# Right Card: North Star (2/3) #}
      <div class="card">
        <h3 class="mb-md">North Star</h3>

        <div id="agent-instructions">
          <div id="instructions-content">
            <p class="text-muted mb-xs">Goal:</p>
            <p class="mb-md" id="agent-goal">Not yet defined</p>

            <div id="success-criteria-section" style="display: none;">
              <p class="text-muted mb-xs">Success Criteria:</p>
              <ul class="mb-md" id="agent-success-criteria"></ul>
            </div>

            <div id="timeline-section" style="display: none;">
              <p class="text-muted mb-xs">Timeline:</p>
              <p id="agent-timeline">Not specified</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script type="module">
  import { initializeUser, getUserId } from '/assets/js/auth/auth.js';

  // Initialize user
  const userId = initializeUser();

  // Get current agent ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const agentId = urlParams.get('id');

  // Chat elements
  const chatMessages = document.getElementById('agent-chat-messages-inner');
  const chatMessagesContainer = document.getElementById('agent-chat-messages');
  const chatForm = document.getElementById('agent-chat-form');
  const messageInput = document.getElementById('agent-message-input');
  const sendButton = document.getElementById('agent-send-button');

  // Chat history (in memory)
  let chatHistory = [];
  let loadingMessageElement = null;

  // Update send button state
  function updateSendButton() {
    const hasContent = messageInput.value.trim().length > 0;
    sendButton.disabled = !hasContent;

    if (hasContent) {
      sendButton.style.background = '#2563eb';
      sendButton.style.cursor = 'pointer';
    } else {
      sendButton.style.background = '#ddd';
      sendButton.style.cursor = 'not-allowed';
    }
  }

  // Show loading message
  function showLoadingMessage() {
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = 'padding: 0.875rem 1rem; border-radius: 8px; max-width: 80%; word-wrap: break-word; line-height: 1.5; background-color: #eff6ff; color: #333; align-self: flex-start; border-left: 3px solid #ddd; border-bottom-left-radius: 4px;';
    loadingDiv.innerHTML = '<span style="color: #999; font-style: italic;">Thinking...</span>';
    chatMessages.appendChild(loadingDiv);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    loadingMessageElement = loadingDiv;
  }

  // Hide loading message
  function hideLoadingMessage() {
    if (loadingMessageElement) {
      loadingMessageElement.remove();
      loadingMessageElement = null;
    }
  }

  // Render a message bubble
  function renderMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'padding: 0.875rem 1rem; border-radius: 8px; max-width: 80%; word-wrap: break-word; line-height: 1.5;';

    if (role === 'assistant') {
      messageDiv.style.cssText += 'background-color: #eff6ff; color: #333; align-self: flex-start; border-left: 3px solid #2563eb; border-bottom-left-radius: 4px;';

      // Render markdown for assistant messages
      if (window.marked) {
        messageDiv.innerHTML = marked.parse(content);
      } else {
        messageDiv.textContent = content;
      }
    } else {
      messageDiv.style.cssText += 'background-color: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 4px;';
      messageDiv.textContent = content;
    }

    chatMessages.appendChild(messageDiv);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
  }

  // Initialize chat with greeting when agent loads
  window.addEventListener('agentLoaded', (event) => {
    const agent = event.detail;
    const greeting = {
      role: 'assistant',
      content: `Ready to break down **${agent.name}**? I'll help you create deliverables to achieve your goal. What context do you need to provide, or should I generate some initial actions?`,
      timestamp: new Date().toISOString()
    };
    chatHistory.push(greeting);
    renderMessage('assistant', greeting.content);
  });

  // Handle form submission
  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    const userMessage = {
      role: 'user',
      content: message,
      timestamp: new Date().toISOString()
    };
    renderMessage('user', message);
    chatHistory.push(userMessage);

    // Clear input
    messageInput.value = '';
    messageInput.style.height = 'auto';
    sendButton.disabled = true;
    sendButton.style.background = '#ddd';
    sendButton.style.cursor = 'not-allowed';

    // Show loading
    showLoadingMessage();

    try {
      // Call backend
      const response = await fetch('/.netlify/functions/agent-chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId,
          agentId,
          message,
          chatHistory: chatHistory.map(msg => ({
            role: msg.role,
            content: msg.content
          }))
        })
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to get response');
      }

      hideLoadingMessage();

      // Add assistant response
      const assistantMessage = {
        role: 'assistant',
        content: data.response,
        timestamp: new Date().toISOString()
      };
      renderMessage('assistant', data.response);
      chatHistory.push(assistantMessage);

      // If actions were generated, refresh the actions list
      if (data.actionsGenerated) {
        // Trigger a reload of the actions grid
        window.dispatchEvent(new CustomEvent('reloadActions'));
      }

    } catch (error) {
      console.error('Error sending message:', error);
      hideLoadingMessage();

      const errorMessage = {
        role: 'assistant',
        content: "I'm having trouble connecting right now. Could you try again?",
        timestamp: new Date().toISOString()
      };
      renderMessage('assistant', errorMessage.content);
      chatHistory.push(errorMessage);
    }
  });

  // Handle Enter key
  messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatForm.requestSubmit();
    }
  });

  // Auto-resize textarea and toggle send button
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    updateSendButton();
  });

  // Handle view switching
  document.querySelectorAll('.agent-nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const view = link.dataset.view;

      // Update link styles
      document.querySelectorAll('.agent-nav-link').forEach(l => {
        if (l.dataset.view === view) {
          l.style.color = '#2563eb';
          l.style.fontWeight = '500';
          l.classList.add('active');
        } else {
          l.style.color = '#6b7280';
          l.style.fontWeight = 'normal';
          l.classList.remove('active');
        }
      });

      // Show/hide content
      document.querySelectorAll('.agent-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(`tab-${view}`).style.display = 'block';

      // Focus chat input when switching to chat
      if (view === 'chat') {
        messageInput.focus();
      }
    });
  });

  // Update action count when actions are loaded/generated
  window.addEventListener('reloadActions', () => {
    // This will be called when actions are generated
    // The actual count update will happen in the existing loadAgentDetail function
  });
</script>
