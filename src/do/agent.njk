---
title: Agent - HabitualOS
layout: base.njk
permalink: /do/agent/
---

<div id="loading-agent" class="mb-xl">
  <p class="text-muted">Loading agent details...</p>
</div>

<div id="agent-error" class="mb-xl" style="display: none;">
  <div class="card">
    <h2 class="mb-md">Agent Not Found</h2>
    <p class="mb-md">The agent you're looking for doesn't exist or you don't have access to it.</p>
    <a href="/do/" class="btn btn-secondary">Back to Dashboard</a>
  </div>
</div>

<div id="agent-detail" style="display: none;">
  {# Breadcrumb Navigation #}
  <div style="margin-bottom: 1.5rem;">
    <a href="/do/" style="color: #6b7280; text-decoration: none; font-size: 0.95rem;">‚Üê Back to Dashboard</a>
  </div>

  {# Centered Header - Always Visible #}
  <div style="text-align: center; margin-bottom: 2rem;">
    <div style="font-size: 4rem; margin-bottom: 0.5rem;">ü§ñ</div>
    <h1 id="agent-name" style="margin: 0 0 0.5rem 0; font-size: 2rem; font-weight: 600;">Agent Name</h1>
    <p id="agent-goal-short" style="margin: 0 auto; max-width: 600px; color: #666; font-size: 0.95rem; line-height: 1.5; padding: 0 1rem">
      Loading goal...
      <a href="#" id="goal-more-link" style="color: #2563eb; text-decoration: none; margin-left: 0.25rem;">more</a>
    </p>
    <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; align-items: center;">
      <a href="#chat" class="view-link" data-view="chat" style="color: #6b7280; text-decoration: none; font-size: 0.9rem;">
        Chat
      </a>
      <span style="color: #ddd;">|</span>
      <a href="#actions" class="view-link" data-view="actions" style="color: #6b7280; text-decoration: none; font-size: 0.9rem;">
        <span id="actions-count">0</span> actions
      </a>
      <span style="color: #ddd;">|</span>
      <a href="#feed" class="view-link" data-view="feed" style="color: #6b7280; text-decoration: none; font-size: 0.9rem;">
        Feed
      </a>
    </div>
  </div>

  {# Chat View (Default) #}
  <div id="view-chat" class="agent-view" style="display: block;">
    {# Chat Interface #}
    <div id="tab-chat" class="agent-tab-content" style="display: block;">
    <div id="agent-chat-container" style="display: flex; flex-direction: column; height: calc(100vh - 280px);">
      <!-- Messages (scrollable area) -->
      <div id="agent-chat-messages" style="flex: 1; min-height: 0; overflow-y: auto; margin-bottom: 1rem;">
        <div id="agent-chat-messages-inner" style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 700px; margin: 0 auto; padding: 1rem;"></div>
      </div>

      <!-- Input area (fixed at bottom) -->
      <div style="flex-shrink: 0; padding: 0 1rem 1rem;">
        <div style="max-width: 700px; margin: 0 auto;">
          <form id="agent-chat-form">
            <div style="position: relative;">
              <textarea
                name="message"
                id="agent-message-input"
                placeholder="Ask about the goal, request actions, or provide context..."
                required
                rows="2"
                style="width: 100%; padding: 0.75rem 3rem 0.75rem 0.75rem; border: 1px solid #ddd; border-radius: 20px; font-size: 1rem; font-family: inherit; resize: none; max-height: 150px; overflow-y: auto; box-sizing: border-box;"
              ></textarea>
              <button
                type="submit"
                id="agent-send-button"
                disabled
                style="position: absolute; right: 0.5rem; bottom: 0.5rem; width: 32px; height: 32px; background: #ddd; color: white; border: none; border-radius: 50%; cursor: not-allowed; transition: all 0.2s; display: flex; align-items: center; justify-content: center; padding: 0;"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M208.49,120.49a12,12,0,0,1-17,0L140,69V216a12,12,0,0,1-24,0V69L64.49,120.49a12,12,0,0,1-17-17l72-72a12,12,0,0,1,17,0l72,72A12,12,0,0,1,208.49,120.49Z"></path>
                </svg>
              </button>
            </div>
          </form>
          <div style="text-align: center; margin-top: 0.5rem;">
            <button
              id="reset-conversation-btn"
              type="button"
              style="padding: 0.5rem 1rem; background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: 500; transition: all 0.2s;"
            >
              üîÑ Reset Conversation
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>

  {# Actions View #}
  <div id="view-actions" class="agent-view" style="display: none;">
    <div id="tab-actions" class="agent-tab-content" style="display: block;">
    <div class="mb-md">
      <div class="flex flex-between">
        <h2>‚ö° Actions</h2>
        <select id="actions-filter" class="actions-filter-select">
          <option value="all">All</option>
          <option value="scheduled">Scheduled</option>
          <option value="active">Active</option>
          <option value="completed">Completed</option>
        </select>
      </div>
    </div>
    <div class="actions-grid" id="agent-actions-grid"></div>
    </div>
  </div>

  {# Feed View #}
  <div id="view-feed" class="agent-view" style="display: none;">
    <div id="tab-feed" class="agent-tab-content" style="display: block;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0;">üìã Feed</h2>
      <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; cursor: pointer;">
        <input type="checkbox" id="show-completed-feed" style="cursor: pointer;">
        Show completed only
      </label>
    </div>

    <div id="feed-empty-state" style="text-align: center; padding: 3rem 1rem; color: #6b7280;">
      <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">No activity yet</p>
      <p style="font-size: 0.95rem;">Your interactions and completed actions will appear here</p>
    </div>

    <div id="feed-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
    </div>
  </div>

  {# Settings View #}
  <div id="view-settings" class="agent-view" style="display: none;">
    <style>
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
      }

      @media (max-width: 768px) {
        .settings-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <div class="settings-grid">

      {# Left Card: Agent Card (Dashboard Style) #}
      <div class="agent-card" id="settings-agent-card">
        <div class="agent-card-header">
          <h3 class="agent-name">‚öôÔ∏è Settings</h3>
          <span class="badge badge-open" id="settings-agent-status-badge">ACTIVE</span>
        </div>

        <div class="agent-metrics">
          <div class="metric-row">
            <span class="metric-label">Model:</span>
            <span class="metric-value" id="settings-agent-model">Sonnet 4.5</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Runtime:</span>
            <span class="metric-value" id="settings-agent-runtime">0 days</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Cost:</span>
            <span class="metric-value" id="settings-agent-cost">$0.00</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Projected:</span>
            <span class="metric-value text-muted" id="settings-agent-projected">~$0.00/mo</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Actions:</span>
            <span class="metric-value" id="settings-agent-actions">0/0</span>
          </div>
        </div>

        <div class="agent-controls">
          <button class="btn btn-sm btn-secondary" id="settings-pause-button">
            Pause
          </button>
        </div>
      </div>

      {# Right Card: North Star (2/3) #}
      <div class="card">
        <h3 class="mb-md">‚ú® North Star</h3>

        <div id="agent-instructions">
          <div id="instructions-content">
            <p class="mb-md" id="agent-goal">Not yet defined</p>

            <div id="success-criteria-section" style="display: none;">
              <h4 class="text-muted mb-xs">Success Criteria</h4>
              <ul class="mb-md" id="agent-success-criteria"></ul>
            </div>

            <div id="timeline-section" style="display: none;">
              <h4 class="text-muted mb-xs">Timeline</h4>
              <p id="agent-timeline">Not specified</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

{# Proposed Asset Modal #}
<div id="proposed-asset-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="max-width: 800px; margin: 2rem auto; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: start; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
      <div style="flex: 1;">
        <h2 id="asset-modal-title" style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; color: #111;">Asset Title</h2>
        <p id="asset-modal-description" style="margin: 0; color: #6b7280; font-size: 0.95rem;">Description</p>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span id="asset-modal-type" style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">type</span>
        <button id="close-asset-modal-header" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">√ó</button>
      </div>
    </div>

    <div style="padding: 1.5rem; max-height: 500px; overflow-y: auto;">
      <pre id="asset-modal-content" style="background: #f9fafb; padding: 1rem; border-radius: 4px; overflow-x: auto; margin: 0; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">Content</pre>
    </div>

    <div style="display: flex; gap: 0.75rem; padding: 1.5rem; border-top: 1px solid #e5e7eb; justify-content: space-between;">
      <button id="delete-asset-btn" style="padding: 0.5rem 1rem; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
        üóëÔ∏è Delete
      </button>
      <div style="display: flex; gap: 0.75rem;">
        <button id="copy-asset-btn" style="padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          üìã Copy to Clipboard
        </button>
        <button id="save-asset-btn" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          üíæ Save to Assets
        </button>
      </div>
    </div>
  </div>
</div>

{# Draft Action Modal #}
<div id="draft-action-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="max-width: 600px; margin: 2rem auto; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
      <h2 id="draft-modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111;">Define Action</h2>
      <button id="close-draft-modal-header" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">√ó</button>
    </div>

    <div style="padding: 1.5rem;">
      <div style="margin-bottom: 1rem;">
        <label for="draft-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Title</label>
        <input
          type="text"
          id="draft-title"
          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;"
          placeholder="2-5 word title"
        />
      </div>

      <div style="margin-bottom: 1rem;">
        <label for="draft-description" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Description</label>
        <textarea
          id="draft-description"
          rows="4"
          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; resize: vertical;"
          placeholder="What you'll create and how"
        ></textarea>
      </div>

      <div style="margin-bottom: 1rem;">
        <label for="draft-priority" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Priority</label>
        <select
          id="draft-priority"
          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem;"
        >
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div id="task-config-section" style="display: none;">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Execution Instructions</label>
          <div id="draft-instructions" style="padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem; color: #4b5563; white-space: pre-wrap;"></div>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Expected Output</label>
          <div id="draft-expected-output" style="padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem; color: #4b5563; white-space: pre-wrap;"></div>
        </div>
      </div>

      <div id="manual-content-section" style="display: none;">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Content <span id="manual-type-badge" style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-left: 0.5rem;"></span></label>
          <pre id="draft-content" style="padding: 0.75rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 0.875rem; color: #4b5563; white-space: pre-wrap; font-family: 'Courier New', monospace; max-height: 300px; overflow-y: auto;"></pre>
        </div>
      </div>
    </div>

    <div style="display: flex; gap: 0.75rem; padding: 1.5rem; border-top: 1px solid #e5e7eb; justify-content: space-between;">
      {# Draft mode buttons (left side) #}
      <button id="delete-draft-btn" style="padding: 0.5rem 1rem; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
        üóëÔ∏è Delete
      </button>

      {# View mode buttons (left side) #}
      <button id="delete-action-btn" style="display: none; padding: 0.5rem 1rem; background: #fee2e2; color: #991b1b; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
        üóëÔ∏è Delete
      </button>

      <div style="display: flex; gap: 0.75rem;">
        {# Draft mode buttons (right side) #}
        <button id="cancel-draft-btn" style="padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          Cancel
        </button>
        <button id="define-action-btn" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          Mark as Defined
        </button>

        {# View mode buttons (right side) #}
        <button id="copy-action-btn" style="display: none; padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          üìã Copy
        </button>
        <button id="complete-action-btn" style="display: none; padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          ‚úì Complete
        </button>
        <button id="close-action-btn" style="display: none; padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 0.95rem; cursor: pointer; font-weight: 500;">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeUser, getUserId } from '/assets/js/auth/auth.js';

  // Initialize user
  const userId = initializeUser();

  // Get current agent ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const agentId = urlParams.get('id');

  // Chat elements
  const chatMessages = document.getElementById('agent-chat-messages-inner');
  const chatMessagesContainer = document.getElementById('agent-chat-messages');
  const chatForm = document.getElementById('agent-chat-form');
  const messageInput = document.getElementById('agent-message-input');
  const sendButton = document.getElementById('agent-send-button');

  // Chat history localStorage management
  const AGENT_CHAT_KEY = `agent-chat-${agentId}`;

  function getAgentChatHistory() {
    try {
      const stored = localStorage.getItem(AGENT_CHAT_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error('Error loading agent chat history:', e);
      return [];
    }
  }

  function saveAgentChatHistory(history) {
    try {
      localStorage.setItem(AGENT_CHAT_KEY, JSON.stringify(history));
    } catch (e) {
      console.error('Error saving agent chat history:', e);
    }
  }

  function clearAgentChatFromLocalStorage() {
    try {
      localStorage.removeItem(AGENT_CHAT_KEY);
    } catch (e) {
      console.error('Error clearing agent chat history:', e);
    }
  }

  // Chat history (load from localStorage or initialize empty)
  let chatHistory = getAgentChatHistory();
  let loadingMessageElement = null;
  let currentChatId = null; // Track Firestore chatId for appending refinements

  // Draft actions stored in localStorage
  const DRAFT_ACTIONS_KEY = `draft-actions-${agentId}`;

  function getDraftActions() {
    try {
      const stored = localStorage.getItem(DRAFT_ACTIONS_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error('Error loading draft actions:', e);
      return [];
    }
  }

  function saveDraftActions(actions) {
    try {
      localStorage.setItem(DRAFT_ACTIONS_KEY, JSON.stringify(actions));
    } catch (e) {
      console.error('Error saving draft actions:', e);
    }
  }

  let draftActions = getDraftActions();

  // Proposed assets stored temporarily (not in localStorage until saved)
  let proposedAssets = [];

  // Track current measurement action for context
  let currentMeasurementActionId = null;
  let currentMeasurementActionContext = null;

  // Save chat history to Firestore when assets/actions are generated
  async function saveChatToFirestore(generatedAssets = [], generatedActions = []) {
    // Don't save if there's no meaningful chat history
    if (chatHistory.length === 0) {
      return;
    }

    try {
      const isNewChat = currentChatId === null;

      const response = await fetch('/.netlify/functions/agent-chat-save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId,
          agentId,
          messages: chatHistory,
          generatedAssets,
          generatedActions,
          chatId: currentChatId, // null for new, existing ID for append
          mode: isNewChat ? 'create' : 'append'
        })
      });

      const data = await response.json();

      if (data.success) {
        if (isNewChat) {
          // Store chatId for future appends
          currentChatId = data.chatId;
          console.log('New chat created in Firestore:', data.chatId);
        } else {
          console.log('Chat appended to Firestore:', currentChatId);
        }
        // Note: localStorage is NOT cleared here - chat continues in localStorage
        // until user explicitly resets via clearChatHistory()
      } else {
        console.error('Failed to save chat:', data.error);
      }
    } catch (error) {
      console.error('Error saving chat to Firestore:', error);
    }
  }

  // Clear chat history after approval (when action defined or asset saved)
  function clearChatHistory() {
    chatHistory = [];
    currentChatId = null;

    // Clear localStorage
    clearAgentChatFromLocalStorage();

    // Clear chat UI
    chatMessages.innerHTML = '';

    // Re-render greeting
    const greeting = {
      role: 'assistant',
      content: `Ready to get to work? I can help suggest next steps, and we can work together to create assets or create actions I'll complete at a scheduled time. How would you like to begin?`,
      timestamp: new Date().toISOString()
    };
    chatHistory.push(greeting);
    saveAgentChatHistory(chatHistory);
    renderMessage('assistant', greeting.content);
  }

  // Update send button state
  function updateSendButton() {
    const hasContent = messageInput.value.trim().length > 0;
    sendButton.disabled = !hasContent;

    if (hasContent) {
      sendButton.style.background = '#2563eb';
      sendButton.style.cursor = 'pointer';
    } else {
      sendButton.style.background = '#ddd';
      sendButton.style.cursor = 'not-allowed';
    }
  }

  // Show loading message
  function showLoadingMessage() {
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = 'padding: 0.875rem 1rem; border-radius: 8px; max-width: 80%; word-wrap: break-word; line-height: 1.5; background-color: #eff6ff; color: #333; align-self: flex-start; border-left: 3px solid #ddd; border-bottom-left-radius: 4px;';
    loadingDiv.innerHTML = '<span style="color: #999; font-style: italic;">Thinking...</span>';
    chatMessages.appendChild(loadingDiv);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    loadingMessageElement = loadingDiv;
  }

  // Hide loading message
  function hideLoadingMessage() {
    if (loadingMessageElement) {
      loadingMessageElement.remove();
      loadingMessageElement = null;
    }
  }

  // Render a message bubble
  function renderMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'padding: 0.875rem 1rem; border-radius: 8px; max-width: 80%; word-wrap: break-word; line-height: 1.5;';

    if (role === 'assistant') {
      messageDiv.style.cssText += 'background-color: #eff6ff; color: #333; align-self: flex-start; border-left: 3px solid #2563eb; border-bottom-left-radius: 4px;';

      // Render markdown for assistant messages
      if (window.marked) {
        messageDiv.innerHTML = marked.parse(content);
      } else {
        messageDiv.textContent = content;
      }
    } else {
      messageDiv.style.cssText += 'background-color: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 4px; white-space: pre-wrap;';
      messageDiv.textContent = content;
    }

    chatMessages.appendChild(messageDiv);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
  }

  // Render a draft action card inline in chat
  function renderDraftActionCard(action) {
    const cardDiv = document.createElement('div');
    cardDiv.dataset.actionId = action.id;
    cardDiv.style.cssText = 'align-self: flex-start; max-width: 80%; width: 100%;';

    const card = document.createElement('div');
    card.className = 'card';
    card.style.cssText = 'cursor: pointer; border: 2px dashed #fbbf24; background-color: #fffbeb; padding: 1rem; margin: 0.5rem 0;';

    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
        <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #92400e;">${action.title}</h4>
        <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">Draft</span>
      </div>
      ${action.description ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #78350f;">${action.description}</p>` : ''}
      <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #a16207;">Click to refine or mark as defined</p>
    `;

    card.onclick = () => openDraftActionModal(action);

    cardDiv.appendChild(card);
    chatMessages.appendChild(cardDiv);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
  }

  // Open modal to view/edit draft action
  let currentDraftAction = null;

  function openDraftActionModal(action) {
    currentDraftAction = action;
    const modal = document.getElementById('draft-action-modal');

    // Reset modal title to draft mode
    document.getElementById('draft-modal-title').textContent = 'Define Action';

    // Populate form fields
    document.getElementById('draft-title').value = action.title;
    document.getElementById('draft-description').value = action.description || '';
    document.getElementById('draft-priority').value = action.priority || 'medium';

    // Enable fields for editing drafts
    document.getElementById('draft-title').disabled = false;
    document.getElementById('draft-description').disabled = false;
    document.getElementById('draft-priority').disabled = false;

    // Show taskConfig section for scheduled/interactive actions
    const taskConfigSection = document.getElementById('task-config-section');
    const manualContentSection = document.getElementById('manual-content-section');

    if (action.taskType === 'manual' && action.content) {
      // Show content for manual actions (formerly assets)
      taskConfigSection.style.display = 'none';
      manualContentSection.style.display = 'block';
      document.getElementById('draft-content').textContent = action.content;
      document.getElementById('manual-type-badge').textContent = action.type || 'text';
    } else if (action.taskConfig && (action.taskConfig.instructions || action.taskConfig.expectedOutput)) {
      // Show taskConfig for scheduled/interactive actions
      manualContentSection.style.display = 'none';
      taskConfigSection.style.display = 'block';
      document.getElementById('draft-instructions').textContent = action.taskConfig.instructions || 'No instructions provided';
      document.getElementById('draft-expected-output').textContent = action.taskConfig.expectedOutput || 'No expected output specified';
    } else {
      // Hide both if neither present
      taskConfigSection.style.display = 'none';
      manualContentSection.style.display = 'none';
    }

    // Show draft mode buttons, hide view mode buttons
    document.getElementById('delete-draft-btn').style.display = 'block';
    document.getElementById('define-action-btn').style.display = 'block';
    document.getElementById('cancel-draft-btn').style.display = 'block';
    document.getElementById('delete-action-btn').style.display = 'none';
    document.getElementById('copy-action-btn').style.display = 'none';
    document.getElementById('complete-action-btn').style.display = 'none';
    document.getElementById('close-action-btn').style.display = 'none';

    // Show modal
    modal.style.display = 'block';
  }

  function closeDraftActionModal() {
    const modal = document.getElementById('draft-action-modal');
    modal.style.display = 'none';
    currentDraftAction = null;
    delete modal.dataset.actionId;

    // Reset fields to editable state (in case we were viewing a defined action)
    document.getElementById('draft-title').disabled = false;
    document.getElementById('draft-description').disabled = false;
    document.getElementById('draft-priority').disabled = false;

    // Reset button visibility and text
    document.getElementById('delete-draft-btn').style.display = 'block';
    document.getElementById('define-action-btn').style.display = 'block';
    document.getElementById('cancel-draft-btn').textContent = 'Cancel';
  }

  function deleteDraftAction() {
    if (!currentDraftAction) return;

    if (!confirm('Are you sure you want to delete this draft action? This cannot be undone.')) {
      return;
    }

    // Remove draft from localStorage
    draftActions = draftActions.filter(a => a.id !== currentDraftAction.id);
    saveDraftActions(draftActions);

    // Remove draft card from chat
    const cardElement = document.querySelector(`[data-action-id="${currentDraftAction.id}"]`);
    if (cardElement) {
      cardElement.remove();
    }

    // Close modal
    closeDraftActionModal();
  }

  async function markAsDefinedFromModal() {
    if (!currentDraftAction) return;

    const title = document.getElementById('draft-title').value.trim();
    const description = document.getElementById('draft-description').value.trim();
    const priority = document.getElementById('draft-priority').value;

    if (!title || !description) {
      alert('Title and description are required');
      return;
    }

    try {
      const payload = {
        userId,
        agentId,
        title,
        description,
        priority,
        taskType: currentDraftAction.taskType || 'scheduled',
        taskConfig: currentDraftAction.taskConfig || {}
      };

      // Include type and content for manual actions (formerly assets)
      if (currentDraftAction.taskType === 'manual') {
        payload.type = currentDraftAction.type;
        payload.content = currentDraftAction.content;
      }

      const response = await fetch('/.netlify/functions/action-define', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to define action');
      }

      // Remove draft from localStorage
      draftActions = draftActions.filter(a => a.id !== currentDraftAction.id);
      saveDraftActions(draftActions);

      // Remove draft card from chat
      const cardElement = document.querySelector(`[data-action-id="${currentDraftAction.id}"]`);
      if (cardElement) {
        cardElement.remove();
      }

      // Close modal
      closeDraftActionModal();

      // Clear chat history for next conversation
      clearChatHistory();

      // Show success message
      alert('Action defined! It will appear in your Actions list.');

      // Trigger action list reload if on actions view
      window.dispatchEvent(new Event('reloadActions'));

    } catch (error) {
      console.error('Error defining action:', error);
      alert(`Failed to define action: ${error.message}`);
    }
  }

  // Render a proposed asset card inline in chat
  function renderProposedAssetCard(asset) {
    const cardDiv = document.createElement('div');
    cardDiv.dataset.assetId = asset.id;
    cardDiv.style.cssText = 'align-self: flex-start; max-width: 80%; width: 100%;';

    const card = document.createElement('div');
    card.className = 'card';
    card.style.cssText = 'cursor: pointer; border: 2px dashed #3b82f6; background-color: #eff6ff; padding: 1rem; margin: 0.5rem 0;';

    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.25rem;">üìÑ</span>
          <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: #1e40af;">${escapeHtml(asset.title)}</h4>
        </div>
        <span style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${asset.type}</span>
      </div>
      ${asset.description ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #1e3a8a;">${escapeHtml(asset.description)}</p>` : ''}
      <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #2563eb;">Click to view, copy, or save</p>
    `;

    card.onclick = () => openProposedAssetModal(asset.id);

    cardDiv.appendChild(card);
    chatMessages.appendChild(cardDiv);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
  }

  // Open modal to view/copy/save proposed asset
  let currentProposedAsset = null;

  function openProposedAssetModal(assetId) {
    const asset = proposedAssets.find(a => a.id === assetId);
    if (!asset) return;

    currentProposedAsset = asset;
    const modal = document.getElementById('proposed-asset-modal');

    // Populate modal
    document.getElementById('asset-modal-title').textContent = asset.title;
    document.getElementById('asset-modal-description').textContent = asset.description;
    document.getElementById('asset-modal-type').textContent = asset.type;
    document.getElementById('asset-modal-content').textContent = asset.content;

    // Show modal
    modal.style.display = 'block';
  }

  function closeProposedAssetModal() {
    const modal = document.getElementById('proposed-asset-modal');
    modal.style.display = 'none';
    currentProposedAsset = null;
  }

  function deleteProposedAsset() {
    if (!currentProposedAsset) return;

    if (!confirm('Are you sure you want to delete this proposed asset? This cannot be undone.')) {
      return;
    }

    // Remove from proposed assets array
    proposedAssets = proposedAssets.filter(a => a.id !== currentProposedAsset.id);

    // Remove asset card from chat
    const cardElement = document.querySelector(`[data-asset-id="${currentProposedAsset.id}"]`);
    if (cardElement) {
      cardElement.remove();
    }

    // Close modal
    closeProposedAssetModal();
  }

  function copyAssetFromModal(event) {
    if (!currentProposedAsset) return;

    navigator.clipboard.writeText(currentProposedAsset.content).then(() => {
      // Provide visual feedback
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úì Copied!';
      btn.style.background = '#10b981';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#f3f4f6';
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard');
    });
  }

  async function saveAssetFromModal() {
    if (!currentProposedAsset) return;

    // Convert proposed asset to saved asset
    const savedAsset = {
      ...currentProposedAsset,
      id: `asset-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      state: 'saved',
      agentId: agentId,
      createdAt: new Date().toISOString()
    };

    // Save to localStorage
    const assets = getAssets(agentId);
    assets.unshift(savedAsset);
    localStorage.setItem(`assets-${agentId}`, JSON.stringify(assets));

    // Remove from proposed assets
    proposedAssets = proposedAssets.filter(a => a.id !== currentProposedAsset.id);

    // Update assets count
    updateAssetsCount(agentId);

    // Close modal
    closeProposedAssetModal();

    // Clear chat history for next conversation
    clearChatHistory();

    // Show success feedback
    alert('Asset saved!');

    // Render feed if on feed view
    if (document.getElementById('view-feed')?.style.display === 'block') {
      renderFeed();
    }

    // Reload actions view if visible
    if (document.getElementById('view-actions')?.style.display === 'block') {
      await loadActions();
    }
  }

  function getAssets(agentId) {
    try {
      const stored = localStorage.getItem(`assets-${agentId}`);
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error('Error loading assets:', e);
      return [];
    }
  }

  function updateAssetsCount(agentId) {
    // No-op: assets-count element no longer exists (replaced with Feed view)
    // Keeping function to avoid breaking existing calls
  }

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function truncate(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }

  function formatDate(isoString) {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;

    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  // Render feed
  async function renderFeed() {
    const container = document.getElementById('feed-list');
    const emptyState = document.getElementById('feed-empty-state');
    const showCompletedOnly = document.getElementById('show-completed-feed')?.checked || false;

    // Load actions from Firestore
    const actions = actionsCache;

    // Filter by completion if needed
    const filteredActions = showCompletedOnly ?
      actions.filter(a => a.state === 'completed') :
      actions;

    if (filteredActions.length === 0) {
      emptyState.style.display = 'block';
      container.innerHTML = '';
      return;
    }

    emptyState.style.display = 'none';

    // Sort chronologically (newest first)
    const sortedActions = [...filteredActions].sort((a, b) => {
      const aTime = new Date(a.completedAt || a._createdAt);
      const bTime = new Date(b.completedAt || b._createdAt);
      return bTime - aTime;
    });

    container.innerHTML = sortedActions.map(action => {
      const isCompleted = action.state === 'completed';
      const icon = action.taskType === 'manual' ? 'üßë' :
                   action.taskType === 'scheduled' ? 'ü§ñ' : '‚ö°';
      const timestamp = isCompleted ? action.completedAt : action._createdAt;
      const eventText = isCompleted ?
        `You completed action <strong>${escapeHtml(action.title)}</strong>` :
        `You created action <strong>${escapeHtml(action.title)}</strong>`;

      return `
        <div class="card" style="padding: 0.75rem 1rem; display: flex; align-items: center; gap: 1rem; ${isCompleted ? '' : 'opacity: 0.6;'}">
          <div style="font-size: 1.5rem;">${icon}</div>
          <div style="flex: 1;">
            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem;">
              ${formatDate(timestamp)}
            </div>
            <div style="font-size: 0.95rem; color: #374151;">
              ${eventText}
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            ${action.taskType === 'manual' && action.content ? `
              <button onclick="viewActionModal('${action.id}')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">
                View
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  // View saved asset in modal
  function viewSavedAsset(assetId) {
    const assets = getAssets(agentId);
    const asset = assets.find(a => a.id === assetId);
    if (!asset) return;

    currentProposedAsset = asset; // Reuse the same modal
    const modal = document.getElementById('proposed-asset-modal');

    document.getElementById('asset-modal-title').textContent = asset.title;
    document.getElementById('asset-modal-description').textContent = asset.description;
    document.getElementById('asset-modal-type').textContent = asset.type;
    document.getElementById('asset-modal-content').textContent = asset.content;

    modal.style.display = 'block';
  }

  // Copy saved asset to clipboard
  function copySavedAsset(assetId) {
    const assets = getAssets(agentId);
    const asset = assets.find(a => a.id === assetId);
    if (!asset) return;

    navigator.clipboard.writeText(asset.content).then(() => {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úì';
      btn.style.background = '#10b981';
      btn.style.color = 'white';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#f3f4f6';
        btn.style.color = '#374151';
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard');
    });
  }

  // Mark asset as complete
  function completeAsset(assetId) {
    const assets = getAssets(agentId);
    const asset = assets.find(a => a.id === assetId);
    if (!asset) return;

    // Add completion timestamp
    asset.completedAt = new Date().toISOString();

    // Save updated assets
    localStorage.setItem(`assets-${agentId}`, JSON.stringify(assets));

    // Update count
    updateAssetsCount(agentId);

    // Re-render
    renderAssets(agentId);
  }

  // Delete saved asset
  function deleteSavedAsset(assetId) {
    if (!confirm('Delete this asset? This cannot be undone.')) return;

    const assets = getAssets(agentId);
    const filtered = assets.filter(a => a.id !== assetId);
    localStorage.setItem(`assets-${agentId}`, JSON.stringify(filtered));

    // Update count
    updateAssetsCount(agentId);

    // Re-render
    renderAssets(agentId);
  }

  // Initialize chat with greeting when agent loads
  window.addEventListener('agentLoaded', async (event) => {
    const agent = event.detail;

    // If we have chat history from localStorage, render it
    if (chatHistory.length > 0) {
      chatHistory.forEach(msg => {
        // Skip tool_use and tool_result messages (internal implementation details)
        // These are needed for API context but don't need to be rendered
        if (typeof msg.content !== 'string') {
          return; // Skip non-string content (tool_use/tool_result)
        }
        renderMessage(msg.role, msg.content);
      });
    } else {
      // No existing history, start with greeting
      const greeting = {
        role: 'assistant',
        content: `Ready to get to work? I can help suggest next steps, and we can work together to create assets or create actions I'll complete at a scheduled time. How would you like to begin?`,
        timestamp: new Date().toISOString()
      };
      chatHistory.push(greeting);
      saveAgentChatHistory(chatHistory);
      renderMessage('assistant', greeting.content);
    }

    // Render any existing draft actions from localStorage
    if (draftActions.length > 0) {
      draftActions.forEach(action => {
        renderDraftActionCard(action);
      });
    }

    // Initialize assets count
    updateAssetsCount(agentId);

    // Initialize view from hash after agent is loaded
    await initializeViewFromHash();
  });

  // Initialize modal event listeners
  document.getElementById('close-draft-modal-header')?.addEventListener('click', closeDraftActionModal);
  document.getElementById('cancel-draft-btn')?.addEventListener('click', closeDraftActionModal);
  document.getElementById('delete-draft-btn')?.addEventListener('click', deleteDraftAction);
  document.getElementById('define-action-btn')?.addEventListener('click', markAsDefinedFromModal);

  document.getElementById('close-asset-modal-header')?.addEventListener('click', closeProposedAssetModal);
  document.getElementById('delete-asset-btn')?.addEventListener('click', deleteProposedAsset);
  document.getElementById('copy-asset-btn')?.addEventListener('click', copyAssetFromModal);
  document.getElementById('save-asset-btn')?.addEventListener('click', saveAssetFromModal);

  // View mode action buttons
  document.getElementById('close-action-btn')?.addEventListener('click', closeDraftActionModal);
  document.getElementById('copy-action-btn')?.addEventListener('click', () => {
    const modal = document.getElementById('draft-action-modal');
    const actionId = modal.dataset.actionId;
    if (actionId) copyActionContent(actionId);
  });
  document.getElementById('complete-action-btn')?.addEventListener('click', async () => {
    const modal = document.getElementById('draft-action-modal');
    const actionId = modal.dataset.actionId;
    if (actionId) {
      await completeAction(actionId);
      closeDraftActionModal();
    }
  });
  document.getElementById('delete-action-btn')?.addEventListener('click', async () => {
    const modal = document.getElementById('draft-action-modal');
    const actionId = modal.dataset.actionId;
    if (actionId && confirm('Are you sure you want to delete this action?')) {
      await deleteAction(actionId);
      closeDraftActionModal();
    }
  });

  // Event delegation for dynamically created asset buttons
  // Note: assets-grid element no longer exists (replaced with Feed view)
  // Commenting out to prevent errors
  // document.getElementById('assets-grid')?.addEventListener('click', (e) => {
  //   const button = e.target.closest('button[data-action]');
  //   if (!button) return;
  //
  //   const action = button.dataset.action;
  //   const assetId = button.dataset.assetId;
  //
  //   if (action === 'view') {
  //     viewSavedAsset(assetId);
  //   } else if (action === 'copy') {
  //     copySavedAsset(assetId);
  //   } else if (action === 'complete') {
  //     completeAsset(assetId);
  //   } else if (action === 'delete') {
  //     deleteSavedAsset(assetId);
  //   }
  // });

  // Handle show completed checkbox in Feed
  document.getElementById('show-completed-feed')?.addEventListener('change', () => {
    renderFeed();
  });

  // Handle reset conversation button
  document.getElementById('reset-conversation-btn')?.addEventListener('click', () => {
    if (confirm('Are you sure you want to reset the conversation? This will clear the chat history.')) {
      clearChatHistory();
    }
  });

  // Handle form submission
  chatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    const userMessage = {
      role: 'user',
      content: message,
      timestamp: new Date().toISOString()
    };
    renderMessage('user', message);
    chatHistory.push(userMessage);
    saveAgentChatHistory(chatHistory);

    // Clear input
    messageInput.value = '';
    messageInput.style.height = 'auto';
    sendButton.disabled = true;
    sendButton.style.background = '#ddd';
    sendButton.style.cursor = 'not-allowed';

    // Show loading
    showLoadingMessage();

    try {
      // Call backend
      const response = await fetch('/.netlify/functions/agent-chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId,
          agentId,
          message,
          chatHistory: chatHistory.map(msg => ({
            role: msg.role,
            content: msg.content
          })),
          actionContext: currentMeasurementActionContext
        })
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to get response');
      }

      hideLoadingMessage();

      // Add assistant response
      const assistantMessage = {
        role: 'assistant',
        content: data.response,
        timestamp: new Date().toISOString()
      };
      renderMessage('assistant', data.response);
      chatHistory.push(assistantMessage);
      saveAgentChatHistory(chatHistory);

      // If draft actions were generated, render them inline and save to localStorage
      if (data.hasDraftActions && data.draftActions) {
        // Add new draft actions to our list
        draftActions = [...draftActions, ...data.draftActions];
        saveDraftActions(draftActions);

        // Render each draft action card inline in chat
        data.draftActions.forEach(action => {
          renderDraftActionCard(action);
        });

        // Save chat to Firestore (first time a deliverable is generated)
        const actionIds = data.draftActions.map(a => a.id);
        saveChatToFirestore([], actionIds);
      }

      // If proposed asset was generated, render it inline (temporary until saved)
      if (data.hasProposedAsset && data.proposedAsset) {
        // Add to proposed assets array (not persisted until user saves)
        proposedAssets.push(data.proposedAsset);

        // Render proposed asset card inline in chat
        renderProposedAssetCard(data.proposedAsset);

        // Save chat to Firestore (first time a deliverable is generated)
        saveChatToFirestore([data.proposedAsset.id], []);
      }

      // Handle measurement check-in completion
      if (data.hasMeasurement && data.measurementData && currentMeasurementActionId) {
        try {
          // Store the measurement
          const measurementResponse = await fetch('/.netlify/functions/measurement-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId,
              agentId,
              actionId: currentMeasurementActionId,
              dimensions: data.measurementData.dimensions,
              notes: data.measurementData.notes || null
            })
          });

          const measurementResult = await measurementResponse.json();

          if (measurementResult.success) {
            // Complete the action (triggers recurrence)
            await completeAction(currentMeasurementActionId);

            // Show completion message
            const completionMessage = {
              role: 'system',
              content: '‚úì Check-in recorded',
              timestamp: new Date().toISOString()
            };
            renderMessage('system', completionMessage.content);
          } else {
            console.error('Failed to store measurement:', measurementResult.error);
          }
        } catch (err) {
          console.error('Error storing measurement:', err);
        } finally {
          // Clear measurement context
          currentMeasurementActionId = null;
          currentMeasurementActionContext = null;
        }
      }

    } catch (error) {
      console.error('Error sending message:', error);
      hideLoadingMessage();

      const errorMessage = {
        role: 'assistant',
        content: "I'm having trouble connecting right now. Could you try again?",
        timestamp: new Date().toISOString()
      };
      renderMessage('assistant', errorMessage.content);
      chatHistory.push(errorMessage);
      saveAgentChatHistory(chatHistory);
    }
  });

  // Handle Enter key
  messageInput?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatForm?.requestSubmit();
    }
  });

  // Auto-resize textarea and toggle send button
  messageInput?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    updateSendButton();
  });

  // Track if actions have been loaded
  let actionsLoaded = false;

  // Lazy-load actions only when needed
  async function ensureActionsLoaded() {
    console.log('[ensureActionsLoaded] Called, actionsLoaded:', actionsLoaded);
    if (actionsLoaded) return;
    console.log('[ensureActionsLoaded] Loading actions...');
    await loadActions();
    actionsLoaded = true;
  }

  // Handle view switching
  async function switchToView(view) {
    console.log('[switchToView] Switching to view:', view);

    // Hide all views
    document.querySelectorAll('.agent-view').forEach(v => {
      v.style.display = 'none';
    });

    // Remove active state from all links
    document.querySelectorAll('.view-link').forEach(l => {
      l.style.color = '#6b7280';
      l.style.fontWeight = 'normal';
    });

    // Add active state to current view link
    const activeLink = document.querySelector(`.view-link[data-view="${view}"]`);
    if (activeLink) {
      activeLink.style.color = '#2563eb';
      activeLink.style.fontWeight = '600';
    }

    // Show selected view
    const viewElement = document.getElementById(`view-${view}`);
    if (viewElement) {
      viewElement.style.display = 'block';
    }

    // Load data and render based on view
    if (view === 'chat') {
      messageInput?.focus();
    } else if (view === 'actions') {
      console.log('[switchToView] Calling ensureActionsLoaded for actions view');
      await ensureActionsLoaded();
      renderActions();
    } else if (view === 'feed') {
      console.log('[switchToView] Calling ensureActionsLoaded for feed view');
      await ensureActionsLoaded();
      renderFeed();
    }

    // Scroll to top
    window.scrollTo(0, 0);
  }

  document.querySelectorAll('.view-link').forEach(link => {
    link.addEventListener('click', async (e) => {
      e.preventDefault();
      const view = link.dataset.view;
      console.log('[view-link click] View clicked:', view);

      // Update URL hash
      window.location.hash = view;

      // Switch to view immediately (don't wait for hashchange event)
      await switchToView(view);
    });
  });

  // Handle "more" link to show settings
  document.getElementById('goal-more-link')?.addEventListener('click', async (e) => {
    e.preventDefault();

    // Update URL hash and switch to settings view
    window.location.hash = 'settings';
    await switchToView('settings');
  });

  // Handle hash-based routing for tab persistence
  async function initializeViewFromHash() {
    // Get hash from URL (remove the # prefix)
    const hash = window.location.hash.substring(1);

    // Valid views
    const validViews = ['chat', 'actions', 'feed', 'settings'];

    // Default to chat if no hash or invalid hash
    const view = validViews.includes(hash) ? hash : 'chat';

    // Switch to the view
    await switchToView(view);
  }

  // Handle hash changes (e.g., browser back/forward)
  window.addEventListener('hashchange', initializeViewFromHash);

  // ==================================================
  // Actions Management (Firestore-backed)
  // ==================================================

  let actionsCache = [];

  // Load actions from Firestore
  async function loadActions() {
    console.log('[loadActions] Fetching actions for userId:', userId, 'agentId:', agentId);
    try {
      const response = await fetch(`/.netlify/functions/actions-list?userId=${userId}&agentId=${agentId}`);
      console.log('[loadActions] Response received:', response.status);
      const data = await response.json();
      console.log('[loadActions] Data:', data);

      if (!data.success) {
        throw new Error(data.error || 'Failed to load actions');
      }

      actionsCache = data.actions || [];
      console.log('[loadActions] Loaded', actionsCache.length, 'actions');
      renderActions();
      updateActionsCount();

    } catch (error) {
      console.error('[actions] Error loading actions:', error);
    }
  }

  // Render actions grid based on filter
  function renderActions() {
    const grid = document.getElementById('agent-actions-grid');
    const filter = document.getElementById('actions-filter').value;

    // Filter actions
    let filteredActions = actionsCache.filter(action => {
      if (filter === 'scheduled') return action.state === 'scheduled';
      if (filter === 'active') return action.state === 'in_progress';
      if (filter === 'completed') return action.state === 'completed';
      return true; // 'all'
    });

    // Sort: in_progress first, then by priority, then by date
    filteredActions.sort((a, b) => {
      if (a.state === 'in_progress' && b.state !== 'in_progress') return -1;
      if (a.state !== 'in_progress' && b.state === 'in_progress') return 1;

      const priorityOrder = { high: 0, medium: 1, low: 2 };
      const aPriority = priorityOrder[a.priority] ?? 1;
      const bPriority = priorityOrder[b.priority] ?? 1;
      if (aPriority !== bPriority) return aPriority - bPriority;

      return new Date(b._createdAt) - new Date(a._createdAt);
    });

    if (filteredActions.length === 0) {
      grid.innerHTML = '<div style="text-align: center; padding: 3rem 1rem; color: #6b7280;"><p style="font-size: 1.125rem; margin-bottom: 0.5rem;">No actions yet</p><p style="font-size: 0.875rem;">Actions you define will appear here</p></div>';
      return;
    }

    grid.innerHTML = filteredActions.map(action => {
      const isManual = action.taskType === 'manual';
      const isMeasurement = action.taskType === 'measurement';
      const isCompleted = action.state === 'completed';
      const priorityColors = {
        high: '#fee2e2',
        medium: '#fef3c7',
        low: '#dbeafe'
      };

      const icon = isMeasurement ? 'üìä' : (isManual ? 'üßë' : (action.taskType === 'scheduled' ? 'ü§ñ' : '‚ö°'));
      const cardOpacity = isCompleted ? 'opacity: 0.6;' : '';
      const clickHandler = isMeasurement && !isCompleted ? `openMeasurementChat('${action.id}')` : `viewActionModal('${action.id}')`;

      return `
        <div class="card" style="padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; ${cardOpacity} cursor: pointer;" onclick="${clickHandler}">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
              <span style="font-size: 1.25rem;">${icon}</span>
              <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">${escapeHtml(action.title)}</h3>
            </div>
            <span style="background: ${priorityColors[action.priority] || priorityColors.medium}; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${action.priority}</span>
          </div>

          <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">${escapeHtml(action.description)}</p>

          ${isManual && action.type ? `<span style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; align-self: flex-start;">${action.type}</span>` : ''}

          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            ${isManual && action.content ? `
              <button onclick="event.stopPropagation(); copyActionContent('${action.id}')" style="padding: 0.375rem 0.75rem; background: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">
                üìã Copy
              </button>
            ` : ''}
            ${!isCompleted ? `
              <button onclick="event.stopPropagation(); completeAction('${action.id}')" style="padding: 0.375rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: 500;">
                ‚úì Complete
              </button>
            ` : ''}
          </div>

          <div style="font-size: 0.75rem; color: #9ca3af;">
            Created ${formatDate(action._createdAt)}
            ${isCompleted ? ` ‚Ä¢ Completed ${formatDate(action.completedAt)}` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  // Open measurement check-in in chat with context
  window.openMeasurementChat = async function(actionId) {
    const action = actionsCache.find(a => a.id === actionId);
    if (!action || action.taskType !== 'measurement') return;

    // Store action context for measurement creation
    currentMeasurementActionId = actionId;
    currentMeasurementActionContext = {
      actionId: action.id,
      title: action.title,
      taskType: action.taskType,
      taskConfig: action.taskConfig
    };

    // Switch to chat view
    const chatLink = document.querySelector('a[data-view="chat"]');
    if (chatLink) chatLink.click();

    // Clear existing chat history for fresh check-in
    chatHistory = [];
    clearAgentChatFromLocalStorage();
    chatMessages.innerHTML = '';

    // Send initial message to start the check-in
    const initialMessage = `I'm ready for my ${action.title} check-in.`;

    // Add user message
    const userMessage = {
      role: 'user',
      content: initialMessage,
      timestamp: new Date().toISOString()
    };
    renderMessage('user', initialMessage);
    chatHistory.push(userMessage);
    saveAgentChatHistory(chatHistory);

    // Show loading
    showLoadingMessage();

    try {
      // Call backend with action context
      const response = await fetch('/.netlify/functions/agent-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId,
          agentId,
          message: initialMessage,
          chatHistory: [],
          actionContext: currentMeasurementActionContext
        })
      });

      const data = await response.json();
      hideLoadingMessage();

      if (data.success) {
        const assistantMessage = {
          role: 'assistant',
          content: data.response,
          timestamp: new Date().toISOString()
        };
        renderMessage('assistant', data.response);
        chatHistory.push(assistantMessage);
        saveAgentChatHistory(chatHistory);
      } else {
        console.error('Error starting measurement chat:', data.error);
      }
    } catch (error) {
      console.error('Error starting measurement chat:', error);
      hideLoadingMessage();
    }
  };

  // View action in draft modal (read-only mode for defined actions)
  window.viewActionModal = function(actionId) {
    const action = actionsCache.find(a => a.id === actionId);
    if (!action) return;

    const modal = document.getElementById('draft-action-modal');
    const taskConfigSection = document.getElementById('task-config-section');
    const manualContentSection = document.getElementById('manual-content-section');

    // Populate fields (make read-only)
    const titleField = document.getElementById('draft-title');
    const descField = document.getElementById('draft-description');
    const priorityField = document.getElementById('draft-priority');

    titleField.value = action.title;
    descField.value = action.description || '';
    priorityField.value = action.priority || 'medium';

    // Make fields read-only for defined actions
    titleField.disabled = true;
    descField.disabled = true;
    priorityField.disabled = true;

    // Show appropriate section based on taskType
    if (action.taskType === 'manual' && action.content) {
      // Show content for manual actions
      taskConfigSection.style.display = 'none';
      manualContentSection.style.display = 'block';
      document.getElementById('draft-content').textContent = action.content;
      document.getElementById('manual-type-badge').textContent = action.type || 'text';
    } else if (action.taskConfig) {
      // Show taskConfig for scheduled/interactive actions
      manualContentSection.style.display = 'none';
      taskConfigSection.style.display = 'block';
      document.getElementById('draft-instructions').textContent = action.taskConfig.instructions || 'No instructions provided';
      document.getElementById('draft-expected-output').textContent = action.taskConfig.expectedOutput || 'No expected output specified';
    } else {
      // Hide both sections if no content
      taskConfigSection.style.display = 'none';
      manualContentSection.style.display = 'none';
    }

    // Update modal title for view mode
    document.getElementById('draft-modal-title').textContent = 'View Action';

    // Update buttons for view mode
    // Hide draft mode buttons
    document.getElementById('delete-draft-btn').style.display = 'none';
    document.getElementById('define-action-btn').style.display = 'none';
    document.getElementById('cancel-draft-btn').style.display = 'none';

    // Show view mode buttons
    document.getElementById('delete-action-btn').style.display = 'block';
    document.getElementById('copy-action-btn').style.display = action.content ? 'block' : 'none'; // Only show if has content
    document.getElementById('complete-action-btn').style.display = action.state === 'completed' ? 'none' : 'block'; // Hide if already completed
    document.getElementById('close-action-btn').style.display = 'block';

    // Store action ID for button handlers
    modal.dataset.actionId = actionId;

    modal.style.display = 'block';
  };

  // Copy action content to clipboard
  window.copyActionContent = function(actionId) {
    const action = actionsCache.find(a => a.id === actionId);
    if (!action || !action.content) return;

    navigator.clipboard.writeText(action.content).then(() => {
      alert('Copied to clipboard!');
    }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard');
    });
  };

  // Complete an action
  window.completeAction = async function(actionId) {
    try {
      const response = await fetch(`/.netlify/functions/action-complete/${actionId}?userId=${userId}`, {
        method: 'POST'
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to complete action');
      }

      // Reload actions
      await loadActions();

      // Refresh Feed view if visible
      if (document.getElementById('view-feed')?.style.display === 'block') {
        renderFeed();
      }

      alert('Action completed!');

    } catch (error) {
      console.error('[actions] Error completing action:', error);
      alert(`Failed to complete action: ${error.message}`);
    }
  };

  // Delete (dismiss) an action
  window.deleteAction = async function(actionId) {
    try {
      const response = await fetch(`/.netlify/functions/action-dismiss/${actionId}?userId=${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          reason: 'User deleted from UI'
        })
      });

      const data = await response.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to delete action');
      }

      // Reload actions
      await loadActions();

      // Refresh Feed view if visible
      if (document.getElementById('view-feed')?.style.display === 'block') {
        renderFeed();
      }

      alert('Action deleted!');

    } catch (error) {
      console.error('[actions] Error deleting action:', error);
      alert(`Failed to delete action: ${error.message}`);
    }
  };

  // Update actions count
  function updateActionsCount() {
    const activeCount = actionsCache.filter(a => a.state !== 'completed' && a.state !== 'dismissed').length;
    document.getElementById('actions-count').textContent = activeCount;
  }

  // Handle filter change
  document.getElementById('actions-filter')?.addEventListener('change', renderActions);

  // Handle reload actions event
  window.addEventListener('reloadActions', async () => {
    await loadActions();
    actionsLoaded = true;
  });
</script>
