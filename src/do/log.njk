---
title: Log Work - HabitualOS
layout: base.njk
permalink: /do/log/
---

<div class="container-narrow" style="max-width: 600px; margin: 0 auto; padding: 2rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="margin: 0;">Log Session</h1>
    <a
      href="/do/"
      style="padding: 0.75rem 1.5rem; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 4px; font-weight: 600; border: 1px solid #ddd;"
    >
      &larr; Back
    </a>
  </div>

  <form id="workForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
    <!-- Project (optional) -->
    <div>
      <label for="projectId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
        Project
      </label>
      <select
        id="projectId"
        name="projectId"
        style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; background: white;"
      >
        <option value="">No project</option>
        <!-- Populated dynamically -->
      </select>
    </div>

    <!-- What did you work on (required) -->
    <div>
      <label for="title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
        What did you work on?
      </label>
      <input
        type="text"
        id="title"
        name="title"
        required
        placeholder="e.g., Resume formatting"
        style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
      />
    </div>

    <!-- Duration (optional) -->
    <div>
      <label for="duration" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
        Duration <span style="color: #999; font-weight: 400;">(minutes, optional)</span>
      </label>
      <input
        type="number"
        id="duration"
        name="duration"
        min="1"
        placeholder="e.g., 45"
        style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
      />
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      id="submitBtn"
      style="padding: 1rem 2rem; background: #0066cc; color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s;"
      onmouseover="this.style.background='#0052a3'"
      onmouseout="this.style.background='#0066cc'"
    >
      Save
    </button>
  </form>
</div>

<!-- EA Modal -->
<div id="ea-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%; text-align: center;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">&#x1F98A;</div>
    <p id="ea-message" style="font-size: 1.1rem; line-height: 1.6; color: #333; margin-bottom: 1.5rem;"></p>
    <button
      id="ea-dismiss"
      style="padding: 0.75rem 2rem; background: #9b59b6; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer;"
    >
      Continue
    </button>
  </div>
</div>

<script type="module">
  import { initializeUser } from '/assets/js/auth/auth.js';

  const form = document.getElementById('workForm');
  const submitBtn = document.getElementById('submitBtn');
  const eaModal = document.getElementById('ea-modal');
  const eaMessage = document.getElementById('ea-message');
  const eaDismiss = document.getElementById('ea-dismiss');

  // Initialize userId
  const userId = initializeUser();

  // Load projects for dropdown
  async function loadProjects() {
    try {
      const response = await fetch(`/.netlify/functions/project-list?userId=${userId}&_=${Date.now()}`, {
        cache: 'no-store'
      });

      const data = await response.json();

      if (data.success && data.projects?.length > 0) {
        const select = document.getElementById('projectId');
        data.projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.id;
          option.textContent = project.name;
          select.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error loading projects:', error);
    }
  }

  // Show EA modal
  function showEAModal(message) {
    eaMessage.textContent = message;
    eaModal.style.display = 'flex';
  }

  // Handle EA dismiss
  eaDismiss.addEventListener('click', () => {
    window.location.href = '/do/';
  });

  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    const formData = {
      userId: userId,
      title: document.getElementById('title').value,
      projectId: document.getElementById('projectId').value || null,
      duration: document.getElementById('duration').value ? parseInt(document.getElementById('duration').value) : null
    };

    try {
      const response = await fetch('/.netlify/functions/work-log-submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (data.success) {
        // Check if EA appeared
        if (data.ea?.message) {
          showEAModal(data.ea.message);
        } else {
          window.location.href = '/do/';
        }
      } else {
        alert('Error: ' + data.error);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save';
      }
    } catch (error) {
      console.error('Error submitting work log:', error);
      alert('Failed to save. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save';
    }
  });

  // Load projects on page load
  loadProjects();
</script>
