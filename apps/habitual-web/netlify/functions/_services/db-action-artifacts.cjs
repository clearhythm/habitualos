//
// netlify/functions/_services/db-action-artifacts.cjs
// ------------------------------------------------------
// DATA ACCESS LAYER (Action Artifacts) for Firestore.
// Manages artifacts (markdown, code, images, data) generated by actions.
//
// Responsibilities:
//   - createArtifact(id, data) - Store artifact
//   - getArtifactsByAction(actionId, userId) - Get action's artifacts
//   - getArtifact(artifactId) - Get single artifact
//
// Schema:
//   {
//     id: "aa-{uuid}",
//     _userId: "u-xyz789",
//     actionId: "action-abc123",
//     type: "markdown",  // "markdown", "code", "image", "data"
//     title: "PRD Draft v1",
//     content: "# Product Requirements...",
//     contentSize: 1234,  // Bytes - track for migration threshold
//     storageType: "firestore",  // "firestore" | "cloud-storage" (future)
//     storagePath: null,  // Cloud Storage path if migrated
//     destination: null,  // File path if saved to disk
//     destinationUrl: null,  // External URL if published
//     _createdAt: Firestore.Timestamp,
//     _updatedAt: Firestore.Timestamp
//   }
// ------------------------------------------------------

const dbCore = require('@habitualos/db-core');

/**
 * Create a new artifact
 * @param {string} id - Artifact ID (with or without "aa-" prefix)
 * @param {Object} data - Artifact data
 * @returns {Promise<Object>} Result with id
 */
exports.createArtifact = async (id, data) => {
  const formattedId = id?.startsWith('aa-') ? id : `aa-${id}`;

  // Calculate content size if content is provided
  const artifactData = { ...data };
  if (data.content && !data.contentSize) {
    artifactData.contentSize = Buffer.byteLength(data.content, 'utf8');
  }

  // Set default storageType to firestore if not specified
  if (!artifactData.storageType) {
    artifactData.storageType = 'firestore';
  }

  await dbCore.create({
    collection: 'action-artifacts',
    id: formattedId,
    data: artifactData
  });

  return { id: formattedId };
};

/**
 * Get all artifacts for an action
 * @param {string} actionId - Action ID
 * @param {string} userId - User ID (for security)
 * @returns {Promise<Array>} Array of artifact documents sorted by creation date
 */
exports.getArtifactsByAction = async (actionId, userId) => {
  const allArtifacts = await dbCore.query({
    collection: 'action-artifacts',
    where: `_userId::eq::${userId}`
  });

  return allArtifacts
    .filter(a => a.actionId === actionId)
    .sort((a, b) => {
      const aTime = a._createdAt?.toDate?.() || new Date(a._createdAt || 0);
      const bTime = b._createdAt?.toDate?.() || new Date(b._createdAt || 0);
      return aTime - bTime; // Ascending order (oldest first)
    });
};

/**
 * Get a single artifact by ID
 * @param {string} artifactId - Artifact ID
 * @returns {Promise<Object|null>} Artifact document or null
 */
exports.getArtifact = async (artifactId) => {
  return await dbCore.get({ collection: 'action-artifacts', id: artifactId });
};
