# =============================================================================
# Build & Dev (Monorepo Configuration)
# =============================================================================
# When deployed, Netlify's "Package directory" should be set to "apps/habitual-web"
# This makes all paths below relative to apps/habitual-web/

[build]
  command = "cd ../.. && pnpm install && pnpm --filter habitual-web build"
  publish = "_site"
  functions = "netlify/functions"

[dev]
  command = "npm run dev"
  targetPort = 8080
  autoLaunch = false

# =============================================================================
# Node.js Functions (netlify/functions/*.js)
# =============================================================================

[functions]
  node_bundler = "esbuild"
  included_files = ["docs/**/*.md"]

# Non-streaming chat endpoint - used as fallback when streaming fails
[functions."agent-chat"]
  timeout = 26  # Must complete before Netlify's 26s limit

# =============================================================================
# Edge Functions (netlify/edge-functions/*.ts)
# Deno runtime, runs at edge locations, no timeout issues with streaming
# =============================================================================

# Generic streaming chat endpoint - handles agent, fox-ea, obi-wai chat types
[[edge_functions]]
  path = "/api/chat-stream"
  function = "chat-stream"

# Legacy streaming endpoint - kept for backwards compatibility
[[edge_functions]]
  path = "/api/agent-chat-stream"
  function = "agent-chat-stream"

# =============================================================================
# Redirects
# =============================================================================

# API gateway - routes /api/* to Node.js functions
# Edge functions at /api/* paths are handled before this redirect
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
  force = true

# SPA-style routing for dynamic pages
[[redirects]]
  from = "/do/action/*"
  to = "/do/action/"
  status = 200
  force = true

[[redirects]]
  from = "/do/file/*"
  to = "/do/file/"
  status = 200
  force = true
