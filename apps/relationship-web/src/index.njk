---
layout: base.njk
title: Pidgerton
permalink: /
---

<div style="max-width: 800px; margin: 0 auto; padding: 2rem; text-align: center;">
  <h1 id="weather-display" style="color: white; font-size: 3rem; margin-bottom: 0.5rem;">Loading...</h1>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 3rem 0;">
    <!-- Capture card -->
    <a href="/capture/" class="home-card">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üëí</div>
      <h2 style="margin: 0 0 1rem 0;">Capture</h2>
      <p style="color: #666;">Capture all the moments.<br/>Happy, sad, or hard?</p>
    </a>

    <!-- Chat card -->
    <a href="/chat/" class="home-card">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üçµ</div>
      <h2 style="margin: 0 0 1rem 0;">Chat</h2>
      <p style="color: #666;">Get private support<br/>from one who knows.</p>
    </a>
  </div>

  <!-- Shared Moments -->
  <div id="shared-moments" style="margin-top: 1rem; text-align: left;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 style="margin: 0; color: #fff; font-size: 1.5rem;">Shared Moments</h2>
      <a href="/moments/" style="color: rgba(255,255,255,0.7); font-size: 0.9rem; text-decoration: none;">View all</a>
    </div>
    <div id="moments-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
      <p id="moments-loading" style="color: rgba(255,255,255,0.5); font-style: italic;">Loading moments...</p>
    </div>
  </div>

  <style>
    @media (max-width: 600px) {
      div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }
    .moment-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .moment-badge-happy { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .moment-badge-sad { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
    .moment-badge-hard { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
  </style>
</div>

<script type="module">
  import { isSignedIn, getUserId, getFirstName } from '/assets/js/auth/auth.js';
  import { animateText } from '/assets/js/components/text-animate.js';
  if (!isSignedIn()) { location.href = '/signin/'; throw new Error('redirecting'); }

  const userId = getUserId();
  const userName = getFirstName();

  // Dynamic weather display
  const weatherEl = document.getElementById('weather-display');
  const WEATHER_CACHE_KEY = 'pidgerton_weather';

  // Show cached weather immediately if available
  let isFirstVisit = false;
  try {
    const cached = JSON.parse(localStorage.getItem(WEATHER_CACHE_KEY));
    if (cached) {
      weatherEl.textContent = `${cached.emoji} ${cached.label}, ${cached.temp}¬∞`;
    } else {
      isFirstVisit = true;
    }
  } catch (e) { isFirstVisit = true; }

  // Async fetch fresh weather
  (async () => {
    try {
      const res = await fetch('/api/weather-current');
      const data = await res.json();
      if (!data.success) return;

      const fresh = { emoji: data.emoji, label: data.label, temp: data.temp };

      if (isFirstVisit) {
        // First visit: animate in from "Loading..." state
        weatherEl.textContent = fresh.emoji + ' ';
        await animateText(weatherEl, `${fresh.label}, ${fresh.temp}¬∞`, { speed: 35, clearFirst: false });
      } else {
        const cached = JSON.parse(localStorage.getItem(WEATHER_CACHE_KEY) || 'null');
        const changed = !cached || cached.temp !== fresh.temp || cached.label !== fresh.label;
        if (changed) {
          weatherEl.textContent = fresh.emoji + ' ';
          await animateText(weatherEl, `${fresh.label}, ${fresh.temp}¬∞`, { speed: 35, clearFirst: false });
        }
      }

      localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify(fresh));
    } catch (e) { /* keep cached/default */ }
  })();

  // Fetch recent moments with replies
  try {
    const res = await fetch('/api/moment-list?limit=5&includeReplies=true');
    const data = await res.json();

    const listEl = document.getElementById('moments-list');
    const loadingEl = document.getElementById('moments-loading');

    if (!data.success || !data.moments || data.moments.length === 0) {
      loadingEl.textContent = 'No moments yet. Capture your first one!';
    } else {
      loadingEl.remove();

      data.moments.forEach(m => {
        const item = document.createElement('div');
        item.style.cssText = 'background: rgba(255,255,255,0.1); border-radius: 10px; padding: 1rem 1.25rem;';

        const badgeClass = `moment-badge-${m.type || 'happy'}`;
        const typeLabel = m.type || 'happy';
        const addedBy = m.addedBy || '';
        const date = new Date(m.occurredAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        // Check if this is partner's moment and has no reply yet
        const isPartnerMoment = addedBy && addedBy !== userName;
        const hasReply = !!m.reply;

        // Reply section
        let replyHtml = '';
        if (hasReply) {
          const replyDate = new Date(m.reply.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          replyHtml = `
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
              <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-bottom: 0.3rem;">${m.reply.sunPoints ? `+${m.reply.sunPoints} ‚Äî ` : ''}${m.reply.repliedBy || ''} replied ${replyDate}</div>
              <p style="margin: 0; color: rgba(255,255,255,0.75); font-size: 0.9rem; line-height: 1.4; font-style: italic;">${m.reply.content}</p>
            </div>
          `;
        } else if (isPartnerMoment) {
          replyHtml = `
            <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem;">
              <span style="color: rgba(255,255,255,0.3); font-size: 0.8rem;">Reply :</span>
              <a href="/chat/?replyTo=${m.id}" style="color: rgba(255,255,255,0.6); font-size: 0.8rem; text-decoration: none; background: rgba(255,255,255,0.08); padding: 0.25rem 0.6rem; border-radius: 6px;">üçµ Chat</a>
              <a style="color: rgba(255,255,255,0.35); font-size: 0.8rem; text-decoration: none; cursor: default; background: rgba(255,255,255,0.04); padding: 0.25rem 0.6rem; border-radius: 6px;" title="Coming soon">‚Ü™Ô∏è Write</a>
            </div>
          `;
        }

        item.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
            <span class="moment-badge ${badgeClass}">${typeLabel}</span>
            ${addedBy ? `<span style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">${addedBy}</span>` : ''}
            <span style="color: rgba(255,255,255,0.35); font-size: 0.8rem; margin-left: auto;">${date}</span>
          </div>
          <p style="margin: 0; color: rgba(255,255,255,0.85); font-size: 0.95rem; line-height: 1.5;">${m.content}</p>
          ${replyHtml}
        `;

        listEl.appendChild(item);
      });
    }
  } catch (err) {
    console.error('Failed to load moments:', err);
    document.getElementById('moments-loading').textContent = 'Failed to load moments.';
  }
</script>
