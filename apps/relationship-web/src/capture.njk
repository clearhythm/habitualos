---
title: Capture - Pidgerton
layout: base.njk
permalink: /capture/
---

<style>
  #moment-content::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }
</style>

<div style="max-width: 500px; margin: 2rem auto; padding: 2rem; text-align: center;">
  <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸ‘’</div>
  <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; color: #fff; font-weight: 600;">Capture</h1>
  <p style="margin: 0 0 2rem 0; font-size: 0.95rem; color: rgba(255,255,255,0.6);">Log a moment, celebratory or challenging.</p>

  <form id="capture-form" class="capture-form">
    <div class="form-group" style="margin-bottom: 1.25rem; text-align: left;">
      <label for="moment-type" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: rgba(255,255,255,0.9);">What kind of moment?</label>
      <select id="moment-type" name="type" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.12); color: #fff; font-size: 1rem; appearance: auto;">
        <option value="happy">Happy</option>
        <option value="sad">Sad</option>
        <option value="hard">Hard</option>
      </select>
    </div>

    <div class="form-group" style="margin-bottom: 1.25rem; text-align: left;">
      <label for="moment-content" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: rgba(255,255,255,0.9);">What happened?</label>
      <textarea id="moment-content" name="content" placeholder="Describe the moment..." rows="4" required style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.12); color: #fff; font-size: 1rem; resize: vertical;"></textarea>
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%;" id="capture-btn">
      Save Moment
    </button>
  </form>
</div>

<script type="module">
  import { isSignedIn, getUserId, getFirstName } from '/assets/js/auth/auth.js';
  import { showToast } from '/assets/js/components/chat-toast.js';

  if (!isSignedIn()) { location.href = '/signin/'; throw new Error('redirecting'); }

  const userId = getUserId();
  const addedBy = getFirstName() || null;

  // Pre-fill from query params (when redirected from chat)
  const params = new URLSearchParams(window.location.search);
  const prefillType = params.get('type');
  const prefillContent = params.get('content');
  const prefillChatId = params.get('chatId');

  if (prefillType) {
    const typeSelect = document.getElementById('moment-type');
    if (['happy', 'sad', 'hard'].includes(prefillType)) {
      typeSelect.value = prefillType;
    }
  }
  if (prefillContent) {
    document.getElementById('moment-content').value = prefillContent;
  }

  const form = document.getElementById('capture-form');
  const btn = document.getElementById('capture-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const type = document.getElementById('moment-type').value;
    const content = document.getElementById('moment-content').value.trim();

    if (!content) return;

    btn.textContent = 'Saving...';
    btn.disabled = true;

    try {
      const res = await fetch('/api/moment-capture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, addedBy, type, content, chatId: prefillChatId || null })
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to save');
      }

      // Redirect to homepage after successful save
      window.location.href = '/';
    } catch (error) {
      console.error('Capture failed:', error);
      showToast('Failed to save. Please try again.', { type: 'error' });
    } finally {
      btn.textContent = 'Save Moment';
      btn.disabled = false;
    }
  });
</script>
